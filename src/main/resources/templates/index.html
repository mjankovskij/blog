<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Blog</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.0/font/bootstrap-icons.min.css"
          integrity="sha512-yLNTU6YQWEtsM/WVkUqd2jRzzq5hmfFUMVvziVlkgC0R9HTElDtyF4DiWiBeMS36npvN+NWwrr764A4AWGcmQQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
<header class="fixed-top">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">BLOG</a>
            <div class="custom-auth-font p-2">
                <span sec:authorize="isAuthenticated()">Welcome, [[${#request.userPrincipal.principal.username}]]!</span>
                <a sec:authorize="isAuthenticated()" href="/logout"> <i class="bi bi-box-arrow-in-right"></i></a>
                <i sec:authorize="isAnonymous()" class="bi bi-lock-fill" id="display-auth"></i>
            </div>
        </div>
    </nav>

    <div class="container-fluid bg-light col-12 col-lg-3 col-md-4 col-sm-6 position-absolute top-100 end-0 p-2 d-none">
        <!--       FORM LOGIN-->
        <div th:replace="fragments/login.html :: info-form"></div>
        <!--FORM REGISTER-->
        <div th:replace="fragments/register.html :: info-form"></div>
    </div>
</header>
<!--    MAIN    -->
<main>
    <div class="container col-12">
<!--    ADD POST    -->
        <div th:replace="fragments/post.html :: info-form"></div>
        <!--    BLOG POSTS  -->
        <div class="alert alert-danger mt-2" th:if="${#lists.isEmpty(posts)}">Blog is empty.</div>
        <div th:each="post: ${posts}">
            <div class="post card mt-4" th:id="${post.getId()}">
                <div class="card-header bg-secondary text-light d-flex justify-content-between position-relative">
                    <b><span th:text="${post.title}" class="col-8 col-sm-7 title"></span></b>
                    <div class="col-4 col-sm-5 text-end">
                        <span th:text="${post.user.username}"></span>,
                        <span th:text="${#dates.format(post.datetime, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>
                    <!--    POST edit/delete    -->
                    <div class="post-edit position-absolute bg-light border top-100 p-2 end-0"
                         sec:authorize="isAuthenticated()"
                         th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')
                         or #authentication.getPrincipal().getId() == post.user.id}">
                        <i class=" bi bi-pencil-fill p-2 edit-post
                    "></i>
                        <i class="bi bi-x-lg p-2 delete-post"></i>
                    </div>
                </div>
                <div class="card-body">
                    <pre><p class="card-text description" th:text="${post.description}"></p></pre>
                </div>
                <!--    COMMENTS    -->
                <div class="card-footer">
                    <div class="text-end">
                        Comments: <span th:text="${post.comments.size}"></span>
                    </div>
                    <div class="col-12 mb-2" th:each="comment: ${post.comments}">
                        <div class="comment position-relative col-12 bg-white border rounded p-2 m-0"
                             th:id="${comment.id}">
                            <b><span th:text="${comment.user.username}"></span></b>
                            <div class="comment-text"><span th:text="${comment.text}"></span></div>
                            <!--    COMMENT edit/delete    -->
                            <div class="comment-edit position-absolute bg-light border top-0 p-0 end-0"
                                 sec:authorize="isAuthenticated()"
                                 th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')') or
                                 #authentication.getPrincipal().getId() == comment.user.id}">
                                <i class="bi bi-pencil-fill p-2 edit-comment"></i>
                                <i class="bi bi-x-lg p-2 delete-comment"></i>
                            </div>
                        </div>
                    </div>
                    <!--    COMMENT add     -->
                    <div th:replace="fragments/comment.html :: info-form"></div>
                </div>
            </div>
        </div>

        -----------
        <div class="row" sec:authorize="hasRole('ROLE_USER')">
            <div class="col-md-10 col-md-offset-2">
                <h2>User Role,</h2>
            </div>
        </div>
        <div class="row" sec:authorize="hasRole('ROLE_ADMIN')">
            <div class="col-md-10 col-md-offset-2">
                <h2>Role Admin,</h2>
            </div>
        </div>
        ----------
        <tbody>
        <tr th:each="user: ${listUsers}">
            <td th:text="${user.username}"></td>
        </tr>
        </tbody>
    </div>

    <div class="shadow-full d-none"></div>
    <div class="response-message-center d-none alert position-fixed p-2 rounded"></div>

    <!-- Modal confirm -->
    <div class="modal" id="confirmModal" style="display: none; z-index: 1050;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body" id="confirmMessage">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="confirmOk">Ok</button>
                    <button class="btn btn-light" id="confirmCancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>


</main>


<!--  Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script
        src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>
<!-- JS -->
<script th:src="@{/js/main.js}"></script>
</body>
</html>